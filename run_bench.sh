#!/bin/bash

OP_NAME=$1
VERSION=$2

if [ -z "$OP_NAME" ] || [ -z "$VERSION" ]; then
    echo "âŒ Usage: bash run_bench.sh <op_name> <version_label>"
    exit 1
fi

DATE=$(date +%Y%m%d)
EXP_DIR="experiments/${OP_NAME}/${DATE}_${VERSION}"
mkdir -p "$EXP_DIR"

echo "ğŸš€ Running benchmark for ${OP_NAME}..."

# 1. è¿è¡Œæµ‹è¯•ã€‚æˆ‘ä»¬åŠ ä¸Š --log-dir . å¼ºåˆ¶å®ƒåœ¨å½“å‰æ‰§è¡Œç›®å½•ç”Ÿæˆ
pytest benchmark/test_unary_pointwise_perf.py -k "${OP_NAME}" --record log

# 2. æ™ºèƒ½å¯»æ‰¾ç”Ÿæˆçš„ log æ–‡ä»¶
# æœç´¢å½“å‰ç›®å½•ä¸‹æœ€è¿‘ 1 åˆ†é’Ÿå†…ç”Ÿæˆçš„ä»¥ result_ å¼€å¤´çš„ .log æ–‡ä»¶
LOG_FILE=$(find . -maxdepth 3 -name "result_*.log" -mmin -1 | head -n 1)

if [ -f "$LOG_FILE" ]; then
    mv "$LOG_FILE" "${EXP_DIR}/result.log"
    echo "âœ… Success! Result saved to: ${EXP_DIR}/result.log"
else
    echo "âŒ Error: No log file generated by pytest."
    echo "è¯·æ£€æŸ¥ benchmark è„šæœ¬æ˜¯å¦æ”¯æŒ --record å‚æ•°ï¼Œæˆ–æ‰‹åŠ¨ç¡®è®¤ log æ–‡ä»¶åã€‚"
    exit 1
fi